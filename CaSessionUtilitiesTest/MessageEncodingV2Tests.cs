using System.Diagnostics;
using System.IO;
using System.Text;
using CaSessionUtilities.Messaging;
using CaSessionUtilities.Messaging.zipV2;
using Org.BouncyCastle.Security;
using Org.BouncyCastle.Utilities.Encoders;

namespace CaSessionUtilitiesTest;

public class MessageEncodingV2Tests
{

    [Fact]
    public void RoundTrip()
    {
        var messageContentArgs = new MessageContentArgs();
        messageContentArgs.Add(new FileArgs("argle", Encoding.UTF8.GetBytes("argle...")));
        messageContentArgs.UnencryptedNote = "note";

        var rdeMessageDecryptionInfo = new RdeMessageDecryptionInfo
        {
            Command = "Now!",
            PcdPublicKey = "01"
        };

        var secretKey = new byte[32];
        new SecureRandom().NextBytes(secretKey);

        var encoder = new ZipMessageEncoder();
        var encoded = encoder.Encode(messageContentArgs, rdeMessageDecryptionInfo, secretKey);

        Trace.WriteLine("Secret Key      : " + Hex.ToHexString(secretKey));
        Trace.WriteLine("Encoded message : " + Hex.ToHexString(encoded));
        Trace.WriteLine("Length :        " + encoded.Length);

        var decoder = new ZipMessageDecoder();
        var actualRdeSessionArgs = decoder.DecodeRdeSessionArgs(encoded);
        Assert.Equal(rdeMessageDecryptionInfo.Command, actualRdeSessionArgs.RdeInfo.Command);
        Assert.Equal(rdeMessageDecryptionInfo.PcdPublicKey, actualRdeSessionArgs.RdeInfo.PcdPublicKey);
        Assert.Equal(16, Hex.Decode(actualRdeSessionArgs.Iv).Length);

        //Pretend we threw the actualRdeSessionArgs at a phone and the MRTD

        var message = decoder.Decode(secretKey);
        Assert.Equal("note", message.Note);
        Assert.Equal("argle", message.Files[0].Filename);
        Assert.Equal("argle...", Encoding.UTF8.GetString(message.Files[0].Content));
    }


    [InlineData("504B0304140008080800298FDD5400000000000000000000000005000000525F315F3133D433D0330000504B070836623B130700000005000000504B0304140008080800298FDD540000000000000000000000000400000041545F31FB1354BCE8F5B5F54B0B2F2DBAF2E3E2E15A00504B070858CF2B561300000010000000504B0304140008080800298FDD5400000000000000000000000005000000525F335F31CBCB2F490500504B070814FABDCF0600000004000000504B0304140008080800298FDD540000000000000000000000000400000041545F337B14AFB326E885B0CCEFDB47A2BF4D0F3C0500504B070897476D3C1300000010000000504B0304140008080800298FDD5400000000000000000000000005000000525F325F31AB56CA2C53B252323133343537747135B574317735B6303675B6347633347133773134B130373050AA0500504B07089EEE5FF32B00000029000000504B0304140008080800298FDD540000000000000000000000000400000041545F325B54F85E6B46D78D7779F96B524B0D2E7C0200504B0708144858231300000010000000504B0304140008080800298FDD5400000000000000000000000005000000525F355F318B5D396753AE75C8B58AF5B7D72ABC9CFF0E00504B07081F1BC5761300000010000000504B0304140008080800298FDD5400000000000000000000000003000000415F35FBBBE3E6A7A77F767CE2CF349E9F5EC1EF0000504B07083C2900361300000010000000504B0304140008080800298FDD5400000000000000000000000005000000525F345F31012000DFFF92B7CE4ABB74ABD259077B936C733897FAD23AA12C520AF68BC2C2BC3E321A96504B070804397D0C2500000020000000504B0304140008080800298FDD540000000000000000000000000400000041545F347B7EE6ED9AE91BE54C4F59E994A53D39750900504B0708B0E5E9571300000010000000504B01021400140008080800298FDD5436623B130700000005000000050000000000000000000000000000000000525F315F31504B01021400140008080800298FDD5458CF2B56130000001000000004000000000000000000000000003A00000041545F31504B01021400140008080800298FDD5414FABDCF060000000400000005000000000000000000000000007F000000525F335F31504B01021400140008080800298FDD5497476D3C13000000100000000400000000000000000000000000B800000041545F33504B01021400140008080800298FDD549EEE5FF32B000000290000000500000000000000000000000000FD000000525F325F31504B01021400140008080800298FDD5414485823130000001000000004000000000000000000000000005B01000041545F32504B01021400140008080800298FDD541F1BC57613000000100000000500000000000000000000000000A0010000525F355F31504B01021400140008080800298FDD543C29003613000000100000000300000000000000000000000000E6010000415F35504B01021400140008080800298FDD5404397D0C250000002000000005000000000000000000000000002A020000525F345F31504B01021400140008080800298FDD54B0E5E957130000001000000004000000000000000000000000008202000041545F34504B0506000000000A000A00F8010000C70200000000")]
    [Theory]
    public void DecodeFromJava(string encoded)
    {
        File.WriteAllBytes("D:\\Fek.zip", Hex.Decode(encoded));

        var rdeSessionArgs = new MessageCipherInfo();

        var decoder = new ZipMessageDecoder();
        var actualRdeSessionArgs = decoder.DecodeRdeSessionArgs(Hex.Decode(encoded));
        Assert.Equal("461571DE59D7E3835C93F14F7D148700", actualRdeSessionArgs.Iv);

        var buffer = Hex.Decode("BE0072912FB5A999C5EC3DF9253E3FB058200B8F621D5C402776CED6A925999B");

        var message = decoder.Decode(buffer);
        Assert.Equal("note", message.Note);
        Assert.Equal("argle", message.Files[0].Filename);
        Assert.Equal("argle...", Encoding.UTF8.GetString(message.Files[0].Content));
    }
}